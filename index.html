<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>WLAN‑Zugang</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family:sans-serif; padding:1rem; }
    .hidden { display:none; }
    .error { color:#b00020; }
    .code { font-size:2rem; color:#0066cc; margin:1rem 0; }
  </style>
</head>
<body>
  <h1>WLAN‑Zugang</h1>

  <div id="form">
    <label>Typ:
      <select id="type">
        <option value="">-- wählen --</option>
        <option value="Schueler">Schüler:innen</option>
        <option value="Lehrer">Lehrer:innen</option>
      </select>
    </label>
    <div id="classRow" class="hidden">
      <label>Klasse:
        <input id="class" type="text" placeholder="z. B. 1BK1W">
      </label>
    </div>
    <label>Vorname (klein):
      <input id="first" type="text">
    </label>
    <label>Initial (klein):
      <input id="init" maxlength="1" type="text">
    </label>
    <button id="btn">Code holen</button>
    <div id="err" class="error"></div>
  </div>

  <div id="result" class="hidden">
    <p>Dein Code:</p>
    <p class="code" id="showCode">----</p>
    <button id="copy">Kopieren</button>
  </div>

  <script>
    const GAS = 'https://script.google.com/macros/s/AKfycbzixNGo6Jer8ZXRupEEcKUxOTHpB-eGOjWGDnoaOCT1-yr65cD_7xVosyh8mRyxGb-2/exec';
    const typeEl  = document.getElementById('type');
    const classEl = document.getElementById('classRow');
    const classIn = document.getElementById('class');
    typeEl.onchange = () => {
      classEl.classList.toggle('hidden', typeEl.value!=='Schueler');
    };

    document.getElementById('btn').onclick = async () => {
      const err = document.getElementById('err');
      err.textContent = '';
      const userType = typeEl.value;
      const klasse  = classIn.value.trim();
      const vor     = document.getElementById('first').value.trim();
      const init    = document.getElementById('init').value.trim();
      if (!userType)      return err.textContent='Typ wählen.';
      if (userType==='Schueler' && !klasse)
                           return err.textContent='Klasse fehlt.';
      if (!/^[a-z]+$/.test(vor) || !/^[a-z]$/.test(init))
                           return err.textContent='Name/Initiale falsch.';
      const params = new URLSearchParams({ action:'generate', userType, klasse, vorname:vor, initial:init });
      let res, json;
      try {
        res = await fetch(GAS+'?'+params);
        json = await res.json();
      } catch {
        return err.textContent='Netzwerk- oder Server-Fehler.';
      }
      if (!json.success) {
        err.textContent = json.error;
        return;
      }
      document.getElementById('showCode').textContent = json.code;
      document.getElementById('form').classList.add('hidden');
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('copy').onclick = () => {
        navigator.clipboard.writeText(json.code);
      };
    };
  </script>
</body>
</html>
