<script>
  const API_URL = 'DEINE_WEBAPP_URL_HIER';

  // beim Laden: Klassen aus Sheet holen
  document.addEventListener('DOMContentLoaded', () => {
    fetch(`${API_URL}?action=getClasses`)
      .then(r => r.json())
      .then(json => {
        const sel = document.getElementById('klasseSelect');
        json.classes.forEach(k => {
          const opt = document.createElement('option');
          opt.value = k; opt.textContent = k;
          sel.appendChild(opt);
        });
        sel.onchange = () => enableNext(2);
      });
  });

  function choose(type) {
    window.userType = type;
    nextStep(1);
  }

  function prev() {
    current = Math.max(1, current - 1);
    showStep(current);
  }

  function nextStep(step) {
    if (step === 2) {
      const sel = document.getElementById('klasseSelect');
      window.klasse = sel.value;
    }
    current = step + 1;
    showStep(current);
  }

  function validateStep3() {
    const v = document.getElementById('vorname').value.trim();
    const i = document.getElementById('initial').value.trim();
    const btn = document.getElementById('btnReq');
    if (v && i.length === 1 && v === v.toLowerCase() && i === i.toLowerCase()) {
      btn.disabled = false;
      btn.classList.remove('disabled');
    } else {
      btn.disabled = true;
      btn.classList.add('disabled');
    }
  }

  function requestCode() {
    showLoading(true);
    const vorname = document.getElementById('vorname').value;
    const initial = document.getElementById('initial').value;
    fetch(`${API_URL}?action=getCode&klasse=${window.klasse}&vorname=${vorname}&initial=${initial}`)
      .then(r => r.json())
      .then(json => {
        showLoading(false);
        if (json.error) {
          document.getElementById('errorBox3').textContent = json.error;
        } else {
          document.getElementById('codeText').textContent = json.code;
          nextStep(3);
        }
      })
      .catch(e => {
        showLoading(false);
        document.getElementById('errorBox3').textContent = 'Netzwerkfehler';
      });
  }

  function showStep(n) {
    document.querySelectorAll('.screen').forEach(s => {
      s.classList.toggle('active', +s.dataset.step === n);
    });
    document.getElementById('progress').style.width = (n - 1) / 3 * 100 + '%';
  }

  function showLoading(on) {
    document.getElementById('loadingOverlay').style.display = on ? 'flex' : 'none';
  }

  document.getElementById('copyBtn').onclick = () => {
    const txt = document.getElementById('codeText').textContent;
    navigator.clipboard.writeText(txt);
  };
</script>
