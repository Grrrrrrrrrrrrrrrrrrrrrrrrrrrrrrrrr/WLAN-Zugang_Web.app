<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>WLAN‑Zugang</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      margin:0; padding:16px;
      font-family:'Roboto',sans-serif;
      background:#eef2f5;
      display:flex; align-items:center; justify-content:center;
      min-height:100vh;
    }
    .card {
      background:#fff;
      border-radius:16px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
      width:100%; max-width:360px;
      overflow:hidden; position:relative;
    }
    header {
      background:#0066cc; color:#fff;
      text-align:center; padding:16px;
      font-size:1.25em; font-weight:500;
      position:relative;
    }
    #progress {
      position:absolute; bottom:0; left:0;
      height:4px; background:#005bb5;
      transition:width 0.3s;
    }
    .screen {
      padding:24px; display:none; opacity:0;
      transition:opacity 0.3s;
    }
    .screen.active { display:block; opacity:1; }
    .buttons {
      margin-top:24px; display:flex; flex-direction:column; gap:12px;
    }
    .btn {
      padding:14px; border:none; border-radius:8px;
      font-size:1em; font-weight:500; cursor:pointer;
      transition:opacity 0.2s;
    }
    .primary {
      background:#0066cc; color:#fff;
    }
    .primary.disabled {
      opacity:0.5; cursor:not-allowed;
    }
    .secondary {
      background:#f5f8fc; color:#333;
    }
    .secondary:hover {
      background:#e0e4ea;
    }
    label {
      display:block; margin-top:16px;
      font-size:0.95em; color:#555;
    }
    input, select {
      width:100%; padding:12px; margin-top:6px;
      font-size:1em; border:1px solid #ccc;
      border-radius:8px; outline:none;
      transition: border-color 0.2s;
    }
    input:focus, select:focus {
      border-color:#0066cc;
    }
    select {
      appearance:none;
      background:url('data:image/svg+xml;utf8,<svg fill="%23666" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 12px center;
      background-size:16px;
    }
    #errorBox, #errorBox3 {
      margin-top:12px; font-size:0.9em; color:#b00020;
      min-height:1.2em; text-align:center;
    }
    #loadingOverlay {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      background:rgba(255,255,255,0.8);
      display:none;
      align-items:center; justify-content:center;
    }
    .spinner {
      border:4px solid #f3f3f3;
      border-top:4px solid #0066cc;
      border-radius:50%; width:36px; height:36px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    /* Ergebnis */
    .codeCard {
      background:#f0f8ff; border-radius:12px;
      padding:24px 16px 16px; text-align:center;
      margin-bottom:16px;
      box-shadow:inset 0 0 8px rgba(0,102,204,0.1);
    }
    .codeText {
      font-size:1.8em; letter-spacing:4px;
      margin:0 0 12px; color:#0066cc; user-select:all;
    }
    #copyBtn {
      display:block; margin:0 auto 16px;
      padding:12px 24px; border:none; border-radius:6px;
      font-size:1em; font-weight:500; cursor:pointer;
      background:#0084ff; color:#fff;
      transition:background 0.2s;
    }
    #copyBtn:hover { background:#006bb3; }
    #resultScreen ol {
      padding-left:20px; text-align:left;
      margin:16px 0; color:#444; font-size:0.9em;
    }
    .warning {
      margin-top:12px; font-size:0.85em;
      color:#555; text-align:center;
    }
  </style>
</head>
<body>
  <div class="card">
    <header>
      WLAN‑Zugang
      <div id="progress" style="width:25%;"></div>
    </header>

    <div id="loadingOverlay">
      <div class="spinner" role="status" aria-label="Lade…"></div>
    </div>

    <div id="formContainer">
      <!-- 1: Wer bist du? -->
      <div class="screen active" data-step="1">
        <p style="text-align:center;color:#333;">Wer bist du?</p>
        <div class="buttons">
          <button class="btn primary" onclick="choose('Schueler')">Schüler:innen</button>
          <button class="btn primary" onclick="choose('Lehrer')">Lehrer:innen</button>
        </div>
      </div>

      <!-- 2: Klasse wählen -->
      <div class="screen" data-step="2">
        <label for="klasseSelect">Klasse wählen:</label>
        <select id="klasseSelect"><option disabled selected>-- wählen --</option></select>
        <div class="buttons">
          <button class="btn secondary" onclick="prev()">Zurück</button>
          <button id="btnNext2" class="btn primary disabled" disabled onclick="nextStep(2)">Weiter</button>
        </div>
        <div id="errorBox"></div>
      </div>

      <!-- 3: Name eingeben -->
      <div class="screen" data-step="3">
        <label for="vorname">Vorname (klein):</label>
        <input id="vorname" type="text" oninput="validateStep3()">
        <label for="initial">Nachnamen-Initiale (klein):</label>
        <input id="initial" maxlength="1" oninput="validateStep3()">
        <div class="buttons">
          <button class="btn secondary" onclick="prev()">Zurück</button>
          <button id="btnReq" class="btn primary disabled" disabled onclick="requestCode()">Monats‑Code anfordern</button>
        </div>
        <div id="errorBox3"></div>
      </div>

      <!-- 4: Ergebnis -->
      <div id="resultScreen" class="screen" data-step="4">
        <div class="codeCard">
          <p class="codeText" id="codeText">----</p>
          <button id="copyBtn">Code kopieren</button>
        </div>
        <h2 style="margin-top:0;font-size:1.1em;color:#333;">So meldest du dich an:</h2>
        <ol>
          <li>WLAN‑Einstellungen öffnen.</li>
          <li>Netzwerk <strong>CSS‑KA‑Gast</strong> wählen.</li>
          <li>Login‑Maske abwarten.</li>
          <li>Code einfügen und verbinden.</li>
          <li>Bei Problemen: Netzwerk entfernen & neu verbinden.</li>
        </ol>
        <div class="warning">Hinweis: Jede Klasse bekommt pro Monat einen Code.</div>
      </div>
    </div>
  </div>
  
 
  
  <script>
   const KLASSEN = [
      "1BK1W","1BK2W","1BKFH","1BKSP","1BKST",
      "2BFSA1","2BFSA2","2BFW1","2BFW2","2BKFR1","2BKFR2",
      "BKSPIT1","BKSPIT2","BKSPIT3",
      "BW 23",
      "FL11","FL12","FL2","FL3",
      "JuHe1","JuHe2",
      "Konf",
      "SGG11","SGG12","SGG21","SGG22","SGGE1","SGGE2"
    ];
    const API_URL = 'https://script.google.com/macros/s/AKfycbyuYuLXT-xfBmbhcbBuAEi8qXY3XjIts7B0D80qHaziAiNL2bXRsG8-i9FEZbbVA_5Wrg/exec';
    let current = 1, userType = '', klasse = '';

  // beim Laden: Klassen aus Sheet holen
  document.addEventListener('DOMContentLoaded', () => {
    fetch(`${API_URL}?action=getClasses`)
      .then(r => r.json())
      .then(json => {
        const sel = document.getElementById('klasseSelect');
        json.classes.forEach(k => {
          const opt = document.createElement('option');
          opt.value = k; opt.textContent = k;
          sel.appendChild(opt);
        });
        sel.onchange = () => enableNext(2);
      });
  });

  function choose(type) {
    window.userType = type;
    nextStep(1);
  }

  function prev() {
    current = Math.max(1, current - 1);
    showStep(current);
  }

  function nextStep(step) {
    if (step === 2) {
      const sel = document.getElementById('klasseSelect');
      window.klasse = sel.value;
    }
    current = step + 1;
    showStep(current);
  }

  function validateStep3() {
    const v = document.getElementById('vorname').value.trim();
    const i = document.getElementById('initial').value.trim();
    const btn = document.getElementById('btnReq');
    if (v && i.length === 1 && v === v.toLowerCase() && i === i.toLowerCase()) {
      btn.disabled = false;
      btn.classList.remove('disabled');
    } else {
      btn.disabled = true;
      btn.classList.add('disabled');
    }
  }

  function requestCode() {
    showLoading(true);
    const vorname = document.getElementById('vorname').value;
    const initial = document.getElementById('initial').value;
    fetch(`${API_URL}?action=getCode&klasse=${window.klasse}&vorname=${vorname}&initial=${initial}`)
      .then(r => r.json())
      .then(json => {
        showLoading(false);
        if (json.error) {
          document.getElementById('errorBox3').textContent = json.error;
        } else {
          document.getElementById('codeText').textContent = json.code;
          nextStep(3);
        }
      })
      .catch(e => {
        showLoading(false);
        document.getElementById('errorBox3').textContent = 'Netzwerkfehler';
      });
  }

  function showStep(n) {
    document.querySelectorAll('.screen').forEach(s => {
      s.classList.toggle('active', +s.dataset.step === n);
    });
    document.getElementById('progress').style.width = (n - 1) / 3 * 100 + '%';
  }

  function showLoading(on) {
    document.getElementById('loadingOverlay').style.display = on ? 'flex' : 'none';
  }

  document.getElementById('copyBtn').onclick = () => {
    const txt = document.getElementById('codeText').textContent;
    navigator.clipboard.writeText(txt);
  };
</script>
